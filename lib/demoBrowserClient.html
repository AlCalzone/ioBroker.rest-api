<html>
<head>
</head>
<body>
    <div id="connected"><span style="color: red">No connection</span></div>
    <div id="output"></div>
<script>
    const IOBROKER_SWAGGER = 'http://localhost:8093/';

    // Demo long polling
    let handler;
    function longPolling(cb) {
        if (cb) {
            handler = cb;
        }

        fetch(`${IOBROKER_SWAGGER}v1/polling`)
            .then(response => response.text())
            .then(data => {
                if (data) {
                    try {
                        data = JSON.parse(data);
                    } catch (error) {
                        console.error('Cannot parse answer: ' + data);
                        return;
                    }

                    if (data.disconnect) {
                        addOutput('Disconnect by command');
                        setConnectionStatus(false);
                        setTimeout(() => connect(), 5000);
                        return;
                    }

                    handler && handler(data);
                }
                longPolling();
            })
        .catch(error => {
            addOutput('Disconnect by error: ' + error);
            setConnectionStatus(false);
            setTimeout(() => connect(), 5000);
        })
    }

    function getState(id) {
        return fetch(`${IOBROKER_SWAGGER}v1/state/${id}`)
            .then(response => response.json())
    }

    function subscribeState(id) {
        return fetch(`${IOBROKER_SWAGGER}v1/state/${id}/subscribe?method=polling`)
            .then(response => response.json());
    }

    const output = [];
    let connecting;

    function addOutput(data) {
        console.log(data);
        output.push(data);
        if (output.length > 40) {
            output.splice(0, output.length - 40);
        }
        document.getElementById('output').innerHTML = output.join('<br/>');
    }

    function setConnectionStatus(isConnected) {
        if (isConnected) {
            document.getElementById('connected').innerHTML = '<span style="color: green">CONNECTED</span>';
        } else {
            document.getElementById('connected').innerHTML = '<span style="color: red">No connection</span>';
        }
    }

    function _connect() {
        // subscribe on changes
        subscribeState('system.adapter.swagger.0.memHeapTotal')
            .then(data => {
                connecting = false;
                setConnectionStatus(true);
                addOutput('Connected and current value is: ' + JSON.stringify(data));

                // subscription done, start long polling
                longPolling(event => {
                    // here will come events
                    addOutput('Event: ' + JSON.stringify(event));
                });
            })
            .catch(() => {
                addOutput('Still try to connect...');
                setConnectionStatus(false);
                setTimeout(() => _connect(), 5000);
            });
    }

    function connect() {
        if (!connecting) {
            connecting = true;
            _connect();
        }
    }

    connect();
</script>
</body>
</html>